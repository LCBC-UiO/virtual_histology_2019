library(shiny); library(shinydashboard);
library(ggplot2); library(dplyr); library(tidyr)
library(purrr); library(DT)
library(ggseg);

load("data/shinydata2.rda")


# Some steals to avoid package installs when only using single func
# Stolen from ggridges: https://github.com/clauswilke/ggridges/blob/master/R/theme.R
theme_custom <- function(font_size = 14, font_family = "", line_size = .5, grid = TRUE, center_axis_labels = FALSE) {
  half_line <- font_size / 2
  small_rel <- 0.857
  small_size <- small_rel * font_size
  color <- "grey90"
  
  if (grid) {
    panel.grid.major <- element_line(colour = color, size = line_size)
    axis.ticks       <- element_line(colour = color, size = line_size)
    axis.ticks.y     <- axis.ticks
  }
  else {
    panel.grid.major <- element_blank()
    axis.ticks       <- element_line(colour = "black", size = line_size)
    axis.ticks.y     <- element_blank()
  }
  
  if (center_axis_labels) {
    axis_just <- 0.5
  }
  else {
    axis_just <- 1.0
  }
  
  theme_grey(base_size = font_size, base_family = font_family) %+replace%
    theme(
      rect              = element_rect(fill = "transparent", colour = NA, color = NA, size = 0, linetype = 0),
      text              = element_text(family = font_family, face = "plain", colour = "black",
                                       size = font_size, hjust = 0.5, vjust = 0.5, angle = 0, lineheight = .9,
                                       margin = margin(), debug = FALSE),
      axis.text         = element_text(colour = "black", size = small_size),
      #axis.title        = element_text(face = "bold"),
      axis.text.x       = element_text(margin = margin(t = small_size / 4), vjust = 1),
      axis.text.y       = element_text(margin = margin(r = small_size / 4), hjust = 1, vjust = 0),
      axis.title.x      = element_text(
        margin = margin(t = small_size / 2, b = small_size / 4),
        hjust = axis_just
      ),
      axis.title.y      = element_text(
        angle = 90,
        margin = margin(r = small_size / 2, l = small_size / 4),
        hjust = axis_just
      ),
      axis.ticks        = axis.ticks,
      axis.ticks.y      = axis.ticks.y,
      axis.line         = element_blank(),
      legend.key        = element_blank(),
      legend.key.size   = grid::unit(1, "lines"),
      legend.text       = element_text(size = rel(small_rel)),
      legend.justification = c("left", "center"),
      panel.background  = element_blank(),
      panel.border      = element_blank(),
      # make grid lines
      panel.grid.major  = panel.grid.major,
      panel.grid.minor  = element_blank(),
      strip.text        = element_text(size = rel(small_rel)),
      strip.background  = element_rect(fill = "grey80", colour = "grey50", size = 0),
      plot.background   = element_blank(),
      plot.title        = element_text(face = "bold",
                                       size = font_size,
                                       margin = margin(b = half_line), hjust = 0),
      plot.subtitle     = element_text(size = rel(small_rel),
                                       hjust = 0, vjust = 1,
                                       margin = margin(b = half_line * small_rel)),
      plot.caption      = element_text(size = rel(small_rel),
                                       hjust = 1, vjust = 1,
                                       margin = margin(t = half_line * small_rel)),
      plot.margin       = margin(half_line, font_size, half_line, half_line),
      
      complete = TRUE
    )
}


# Stolen from scales
squish <- function (x, range = c(0, 1), only.finite = TRUE) {
  force(range)
  finite <- if (only.finite) 
    is.finite(x)
  else TRUE
  x[finite & x < range[1]] <- range[1]
  x[finite & x > range[2]] <- range[2]
  x
}

# Specify some values
age <- c(4, 4.17234468937876, 4.34468937875751, 4.51703406813627, 4.68937875751503, 
         4.86172344689379, 5.03406813627254, 5.2064128256513, 5.37875751503006, 
         5.55110220440882, 5.72344689378757, 5.89579158316633, 6.06813627254509, 
         6.24048096192385, 6.41282565130261, 6.58517034068136, 6.75751503006012, 
         6.92985971943888, 7.10220440881764, 7.27454909819639, 7.44689378757515, 
         7.61923847695391, 7.79158316633267, 7.96392785571142, 8.13627254509018, 
         8.30861723446894, 8.4809619238477, 8.65330661322645, 8.82565130260521, 
         8.99799599198397, 9.17034068136273, 9.34268537074148, 9.51503006012024, 
         9.687374749499, 9.85971943887776, 10.0320641282565, 10.2044088176353, 
         10.376753507014, 10.5490981963928, 10.7214428857715, 10.8937875751503, 
         11.0661322645291, 11.2384769539078, 11.4108216432866, 11.5831663326653, 
         11.7555110220441, 11.9278557114228, 12.1002004008016, 12.2725450901804, 
         12.4448897795591, 12.6172344689379, 12.7895791583166, 12.9619238476954, 
         13.1342685370741, 13.3066132264529, 13.4789579158317, 13.6513026052104, 
         13.8236472945892, 13.9959919839679, 14.1683366733467, 14.3406813627255, 
         14.5130260521042, 14.685370741483, 14.8577154308617, 15.0300601202405, 
         15.2024048096192, 15.374749498998, 15.5470941883768, 15.7194388777555, 
         15.8917835671343, 16.064128256513, 16.2364729458918, 16.4088176352705, 
         16.5811623246493, 16.7535070140281, 16.9258517034068, 17.0981963927856, 
         17.2705410821643, 17.4428857715431, 17.6152304609218, 17.7875751503006, 
         17.9599198396794, 18.1322645290581, 18.3046092184369, 18.4769539078156, 
         18.6492985971944, 18.8216432865731, 18.9939879759519, 19.1663326653307, 
         19.3386773547094, 19.5110220440882, 19.6833667334669, 19.8557114228457, 
         20.0280561122244, 20.2004008016032, 20.372745490982, 20.5450901803607, 
         20.7174348697395, 20.8897795591182, 21.062124248497, 21.2344689378758, 
         21.4068136272545, 21.5791583166333, 21.751503006012, 21.9238476953908, 
         22.0961923847695, 22.2685370741483, 22.4408817635271, 22.6132264529058, 
         22.7855711422846, 22.9579158316633, 23.1302605210421, 23.3026052104208, 
         23.4749498997996, 23.6472945891784, 23.8196392785571, 23.9919839679359, 
         24.1643286573146, 24.3366733466934, 24.5090180360721, 24.6813627254509, 
         24.8537074148297, 25.0260521042084, 25.1983967935872, 25.3707414829659, 
         25.5430861723447, 25.7154308617234, 25.8877755511022, 26.060120240481, 
         26.2324649298597, 26.4048096192385, 26.5771543086172, 26.749498997996, 
         26.9218436873747, 27.0941883767535, 27.2665330661323, 27.438877755511, 
         27.6112224448898, 27.7835671342685, 27.9559118236473, 28.1282565130261, 
         28.3006012024048, 28.4729458917836, 28.6452905811623, 28.8176352705411, 
         28.9899799599198, 29.1623246492986, 29.3346693386774, 29.5070140280561, 
         29.6793587174349, 29.8517034068136, 30.0240480961924, 30.1963927855711, 
         30.3687374749499, 30.5410821643287, 30.7134268537074, 30.8857715430862, 
         31.0581162324649, 31.2304609218437, 31.4028056112224, 31.5751503006012, 
         31.74749498998, 31.9198396793587, 32.0921843687375, 32.2645290581162, 
         32.436873747495, 32.6092184368737, 32.7815631262525, 32.9539078156313, 
         33.12625250501, 33.2985971943888, 33.4709418837675, 33.6432865731463, 
         33.8156312625251, 33.9879759519038, 34.1603206412826, 34.3326653306613, 
         34.5050100200401, 34.6773547094188, 34.8496993987976, 35.0220440881764, 
         35.1943887775551, 35.3667334669339, 35.5390781563126, 35.7114228456914, 
         35.8837675350701, 36.0561122244489, 36.2284569138277, 36.4008016032064, 
         36.5731462925852, 36.7454909819639, 36.9178356713427, 37.0901803607214, 
         37.2625250501002, 37.434869739479, 37.6072144288577, 37.7795591182365, 
         37.9519038076152, 38.124248496994, 38.2965931863727, 38.4689378757515, 
         38.6412825651303, 38.813627254509, 38.9859719438878, 39.1583166332665, 
         39.3306613226453, 39.5030060120241, 39.6753507014028, 39.8476953907816, 
         40.0200400801603, 40.1923847695391, 40.3647294589178, 40.5370741482966, 
         40.7094188376754, 40.8817635270541, 41.0541082164329, 41.2264529058116, 
         41.3987975951904, 41.5711422845691, 41.7434869739479, 41.9158316633267, 
         42.0881763527054, 42.2605210420842, 42.4328657314629, 42.6052104208417, 
         42.7775551102204, 42.9498997995992, 43.122244488978, 43.2945891783567, 
         43.4669338677355, 43.6392785571142, 43.811623246493, 43.9839679358717, 
         44.1563126252505, 44.3286573146293, 44.501002004008, 44.6733466933868, 
         44.8456913827655, 45.0180360721443, 45.190380761523, 45.3627254509018, 
         45.5350701402806, 45.7074148296593, 45.8797595190381, 46.0521042084168, 
         46.2244488977956, 46.3967935871744, 46.5691382765531, 46.7414829659319, 
         46.9138276553106, 47.0861723446894, 47.2585170340681, 47.4308617234469, 
         47.6032064128256, 47.7755511022044, 47.9478957915832, 48.1202404809619, 
         48.2925851703407, 48.4649298597194, 48.6372745490982, 48.809619238477, 
         48.9819639278557, 49.1543086172345, 49.3266533066132, 49.498997995992, 
         49.6713426853707, 49.8436873747495, 50.0160320641283, 50.188376753507, 
         50.3607214428858, 50.5330661322645, 50.7054108216433, 50.877755511022, 
         51.0501002004008, 51.2224448897796, 51.3947895791583, 51.5671342685371, 
         51.7394789579158, 51.9118236472946, 52.0841683366734, 52.2565130260521, 
         52.4288577154309, 52.6012024048096, 52.7735470941884, 52.9458917835671, 
         53.1182364729459, 53.2905811623246, 53.4629258517034, 53.6352705410822, 
         53.8076152304609, 53.9799599198397, 54.1523046092184, 54.3246492985972, 
         54.496993987976, 54.6693386773547, 54.8416833667335, 55.0140280561122, 
         55.186372745491, 55.3587174348697, 55.5310621242485, 55.7034068136273, 
         55.875751503006, 56.0480961923848, 56.2204408817635, 56.3927855711423, 
         56.565130260521, 56.7374749498998, 56.9098196392786, 57.0821643286573, 
         57.2545090180361, 57.4268537074148, 57.5991983967936, 57.7715430861723, 
         57.9438877755511, 58.1162324649299, 58.2885771543086, 58.4609218436874, 
         58.6332665330661, 58.8056112224449, 58.9779559118236, 59.1503006012024, 
         59.3226452905812, 59.4949899799599, 59.6673346693387, 59.8396793587174, 
         60.0120240480962, 60.184368737475, 60.3567134268537, 60.5290581162325, 
         60.7014028056112, 60.87374749499, 61.0460921843687, 61.2184368737475, 
         61.3907815631263, 61.563126252505, 61.7354709418838, 61.9078156312625, 
         62.0801603206413, 62.25250501002, 62.4248496993988, 62.5971943887776, 
         62.7695390781563, 62.9418837675351, 63.1142284569138, 63.2865731462926, 
         63.4589178356713, 63.6312625250501, 63.8036072144289, 63.9759519038076, 
         64.1482965931864, 64.3206412825651, 64.4929859719439, 64.6653306613227, 
         64.8376753507014, 65.0100200400802, 65.1823647294589, 65.3547094188377, 
         65.5270541082164, 65.6993987975952, 65.8717434869739, 66.0440881763527, 
         66.2164328657315, 66.3887775551102, 66.561122244489, 66.7334669338677, 
         66.9058116232465, 67.0781563126253, 67.250501002004, 67.4228456913828, 
         67.5951903807615, 67.7675350701403, 67.939879759519, 68.1122244488978, 
         68.2845691382766, 68.4569138276553, 68.6292585170341, 68.8016032064128, 
         68.9739478957916, 69.1462925851703, 69.3186372745491, 69.4909819639279, 
         69.6633266533066, 69.8356713426854, 70.0080160320641, 70.1803607214429, 
         70.3527054108216, 70.5250501002004, 70.6973947895792, 70.8697394789579, 
         71.0420841683367, 71.2144288577154, 71.3867735470942, 71.559118236473, 
         71.7314629258517, 71.9038076152305, 72.0761523046092, 72.248496993988, 
         72.4208416833667, 72.5931863727455, 72.7655310621243, 72.937875751503, 
         73.1102204408818, 73.2825651302605, 73.4549098196393, 73.627254509018, 
         73.7995991983968, 73.9719438877756, 74.1442885771543, 74.3166332665331, 
         74.4889779559118, 74.6613226452906, 74.8336673346693, 75.0060120240481, 
         75.1783567134269, 75.3507014028056, 75.5230460921844, 75.6953907815631, 
         75.8677354709419, 76.0400801603206, 76.2124248496994, 76.3847695390782, 
         76.5571142284569, 76.7294589178357, 76.9018036072144, 77.0741482965932, 
         77.2464929859719, 77.4188376753507, 77.5911823647295, 77.7635270541082, 
         77.935871743487, 78.1082164328657, 78.2805611222445, 78.4529058116233, 
         78.625250501002, 78.7975951903808, 78.9699398797595, 79.1422845691383, 
         79.314629258517, 79.4869739478958, 79.6593186372746, 79.8316633266533, 
         80.0040080160321, 80.1763527054108, 80.3486973947896, 80.5210420841683, 
         80.6933867735471, 80.8657314629259, 81.0380761523046, 81.2104208416834, 
         81.3827655310621, 81.5551102204409, 81.7274549098196, 81.8997995991984, 
         82.0721442885772, 82.2444889779559, 82.4168336673347, 82.5891783567134, 
         82.7615230460922, 82.9338677354709, 83.1062124248497, 83.2785571142285, 
         83.4509018036072, 83.623246492986, 83.7955911823647, 83.9679358717435, 
         84.1402805611223, 84.312625250501, 84.4849699398798, 84.6573146292585, 
         84.8296593186373, 85.002004008016, 85.1743486973948, 85.3466933867736, 
         85.5190380761523, 85.6913827655311, 85.8637274549098, 86.0360721442886, 
         86.2084168336673, 86.3807615230461, 86.5531062124249, 86.7254509018036, 
         86.8977955911824, 87.0701402805611, 87.2424849699399, 87.4148296593186, 
         87.5871743486974, 87.7595190380761, 87.9318637274549, 88.1042084168337, 
         88.2765531062124, 88.4488977955912, 88.6212424849699, 88.7935871743487, 
         88.9659318637275, 89.1382765531062, 89.310621242485, 89.4829659318637, 
         89.6553106212425, 89.8276553106212, 90)

gene_trajs = unique(gene_traj_db$gene)
AgeU <- c("5", "7", "9", "11", "13", "15", "17", "19", "21", "23", "25", 
          "27", "29", "31", "33", "35", "37", "39", "41", "43", "45", "47", 
          "49", "51", "53", "55", "57", "59", "61", "63", "65", "67", "69", 
          "71", "73", "75", "77", "79", "81", "83", "85", "87", "89")
stat <- c("edf", "Ref.df", "F", "p.value", "rsq", "Estimate_.Intercept.", 
          "Estimate_SexMale", "Estimate_Site_NamentnuAvanto", "Estimate_Site_NameousAvanto", 
          "Estimate_Site_NameousPrisma", "t.value_.Intercept.", "t.value_SexMale", 
          "t.value_Site_NamentnuAvanto", "t.value_Site_NameousAvanto", 
          "t.value_Site_NameousPrisma", "Pr...t.._.Intercept.", "Pr...t.._SexMale", 
          "Pr...t.._Site_NamentnuAvanto", "Pr...t.._Site_NameousAvanto", 
          "Pr...t.._Site_NameousPrisma")
gglim <- c(-0.0426922271379553, 0.0171811414375472)
region <- c("bankssts", "caudalanteriorcingulate", "caudalmiddlefrontal", 
            "cuneus", "entorhinal", "frontalpole", "fusiform", "inferiorparietal", 
            "inferiortemporal", "insula", "isthmuscingulate", "lateraloccipital", 
            "lateralorbitofrontal", "lingual", "medialorbitofrontal", "middletemporal", 
            "paracentral", "parahippocampal", "parsopercularis", "parsorbitalis", 
            "parstriangularis", "pericalcarine", "postcentral", "posteriorcingulate", 
            "precentral", "precuneus", "rostralanteriorcingulate", "rostralmiddlefrontal", 
            "superiorfrontal", "superiorparietal", "superiortemporal", "supramarginal", 
            "temporalpole", "transversetemporal")

